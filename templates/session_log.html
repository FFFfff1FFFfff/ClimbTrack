<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <meta name="language" content="en">
    <title>Log Climb Sessions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Saira+Condensed:wght@700;400&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Saira Condensed', Arial, sans-serif; background: #F5F5F7; }
        .upload-btn-wrapper { display: flex; justify-content: center; margin-bottom: 2.5rem; }
        .big-plus-btn {
            width: 90px; height: 90px; border-radius: 50%; background: #E84444; color: #fff;
            font-size: 3.5rem; display: flex; align-items: center; justify-content: center;
            border: none; box-shadow: 0 4px 24px 0 rgba(31,38,135,0.10); cursor: pointer;
            transition: background 0.2s, transform 0.15s;
        }
        .big-plus-btn:hover { background: #c9302c; transform: scale(1.08); }
        .timeline { max-width: 700px; margin: 0 auto; }
        .timeline-day-group {
            border: 2px dashed #E84444;
            border-radius: 1.2rem;
            margin-bottom: 2.5rem;
            padding: 1.2rem 1.2rem 0.5rem 1.2rem;
            background: #fff;
        }
        .timeline-day-label {
            font-size: 1.2rem;
            font-weight: 700;
            color: #E84444;
            margin-bottom: 1.2rem;
            margin-left: 0.2rem;
        }
        .timeline-entry { background: none; border-radius: 1.2rem; box-shadow: none; margin-bottom: 1.5rem; padding: 0; display: flex; gap: 1.5rem; align-items: flex-start; }
        .timeline-img { width: 180px; height: 180px; object-fit: cover; border-radius: 1rem; background: #eee; }
        .timeline-content { flex: 1; }
        .timeline-date { color: #888; font-size: 1rem; margin-bottom: 0.5rem; }
        .timeline-grade { color: #E84444; font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .timeline-type { color: #666; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.3rem; }
        .timeline-route-info { color: #888; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.3rem; }
        .timeline-note { color: #222; font-size: 1.1rem; }
        .no-log { color: #aaa; text-align: center; margin-top: 3rem; font-size: 1.2rem; }
        .back-btn { margin-bottom: 2rem; }
        .navbar-custom { background: transparent; padding: 1.2rem 3rem 0.5rem 3rem; }
        .navbar-custom .navbar-brand { color: #000; font-size: 2rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }
        .navbar-custom .nav-link { color: #000; font-size: 1.1rem; font-weight: 700; margin-right: 1.5rem; text-transform: uppercase; }
        .navbar-custom .btn-login { background: #E84444; color: #fff; border: none; border-radius: 2px; padding: 0.4rem 1.2rem; font-weight: 700; text-transform: uppercase; font-size: 1.1rem; }
        
        /* Delete button styles */
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 0.5rem;
            display: none; /* Initially hidden */
        }
        .delete-btn:hover {
            background: #c82333;
        }
        
        /* Edit button styles */
        .edit-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            display: none; /* Initially hidden */
        }
        .edit-btn:hover {
            background: #0056b3;
        }
        
        .timeline-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: flex-start;
            margin-left: auto;
        }
        
        /* Manage button styles */
        .manage-btn-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .manage-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .manage-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        .manage-btn.active {
            background: #E84444;
        }
        .manage-btn.active:hover {
            background: #c9302c;
        }
        
        /* Show delete buttons when in manage mode */
        .manage-mode .delete-btn {
            display: flex;
        }
        
        /* Show edit buttons when in manage mode */
        .manage-mode .edit-btn {
            display: flex;
        }
        
        /* Force English locale for form elements */
        input[type="file"]::-webkit-file-upload-button {
            font-family: 'Saira Condensed', Arial, sans-serif;
        }
        input[type="date"] {
            font-family: 'Saira Condensed', Arial, sans-serif;
        }
        /* Ensure all form elements use English locale */
        form, input, select, textarea {
            font-family: 'Saira Condensed', Arial, sans-serif;
        }
        
        /* Custom file input styling to override Chinese text */
        .custom-file-input {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .custom-file-input input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
        }
        .custom-file-label {
            display: block;
            padding: 0.375rem 0.75rem;
            margin-bottom: 0;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-image: none;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .custom-file-label:after {
            content: "Browse";
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            z-index: 3;
            display: block;
            height: calc(1.5em + 0.75rem);
            padding: 0.375rem 0.75rem;
            line-height: 1.5;
            color: #495057;
            background-color: #e9ecef;
            border-left: 1px solid #ced4da;
            border-radius: 0 0.375rem 0.375rem 0;
            font-family: 'Saira Condensed', Arial, sans-serif;
        }
        .custom-file-input input[type="file"]:focus ~ .custom-file-label {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        /* Custom date input styling to override Chinese text */
        .custom-date-input {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .custom-date-input input[type="date"] {
            width: 100%;
            padding: 0.375rem 0.75rem;
            font-size: 1rem; 
            font-weight: 400;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            font-family: 'Saira Condensed', Arial, sans-serif;
        }
        .custom-date-input input[type="date"]:focus {
            color: #495057;
            background-color: #fff;
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        /* Simple approach - just ensure proper display */
        .custom-date-input input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }
        
        /* Custom Date Picker Styles */
        .date-picker-wrapper {
            position: relative;
            width: 100%;
        }
        .date-picker-input {
            width: 100%;
            padding: 0.375rem 2.5rem 0.375rem 0.75rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            cursor: pointer;
            font-family: 'Saira Condensed', Arial, sans-serif;
        }
        .date-picker-input:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .date-picker-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #6c757d;
        }
        .date-picker-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            padding: 1rem;
        }
        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .date-picker-nav {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        .date-picker-nav:hover {
            background-color: #f8f9fa;
        }
        .date-picker-month-year {
            font-weight: 600;
            color: #495057;
        }
        .date-picker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }
        .date-picker-day-header {
            text-align: center;
            font-weight: 600;
            color: #6c757d;
            padding: 0.5rem;
            font-size: 0.875rem;
        }
        .date-picker-day {
            text-align: center;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 0.25rem;
            border: none;
            background: none;
            font-family: 'Saira Condensed', Arial, sans-serif;
        }
        .date-picker-day:hover {
            background-color: #e9ecef;
        }
        .date-picker-day.selected {
            background-color: #E84444;
            color: white;
        }
        .date-picker-day.other-month {
            color: #adb5bd;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">ClimbTrack</a>
            <div class="collapse navbar-collapse justify-content-end">
                <ul class="navbar-nav mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('about') }}">About</a></li>
                    {% if session.get('user') %}
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('profile') }}">{{ session['user'] }}</a></li>
                        <li class="nav-item"><a class="btn btn-login" href="{{ url_for('logout') }}">Logout</a></li>
                    {% else %}
                        <li class="nav-item"><a class="btn btn-login" href="{{ url_for('login') }}">Login</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    <div class="container py-4 timeline">
        <div class="upload-btn-wrapper">
            <button class="big-plus-btn" data-bs-toggle="modal" data-bs-target="#uploadModal">+</button>
        </div>
        <div class="manage-btn-wrapper">
            <button class="manage-btn" id="manageBtn">Manage</button>
        </div>
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="alert alert-success">{{ messages[0] }}</div>
          {% endif %}
        {% endwith %}
        {% if grouped_logs and grouped_logs|length > 0 %}
            {% for day, logs in grouped_logs.items() %}
                <div class="timeline-day-group">
                    <div class="timeline-day-label">{{ day }}</div>
                    {% for log in logs %}
                    <div class="timeline-entry">
                        {% if log.image %}
                            <img src="/static/uploads/{{ log.image }}" class="timeline-img" alt="Climb photo">
                        {% else %}
                            <div class="timeline-img"></div>
                        {% endif %}
                        <div class="timeline-content">
                            <div class="timeline-grade">Route #{{ log.route_id }}</div>
                            <div class="timeline-type">{{ log.route_name }}</div>
                            {% if log.route_type and log.route_difficulty %}
                            <div class="timeline-route-info">{{ log.route_type }} - {{ log.route_difficulty }}</div>
                            {% endif %}
                            <div class="timeline-note">{{ log.note }}</div>
                            <div class="timeline-date">{{ log.date }}</div>
                        </div>
                        <div class="timeline-actions">
                            <button class="edit-btn" data-bs-toggle="modal" data-bs-target="#editModal" 
                                    data-bs-log-id="{{ log.id }}" 
                                    data-bs-log-name="{{ log.name }}"
                                    data-bs-log-route-id="{{ log.route_id }}"
                                    data-bs-log-note="{{ log.note }}"
                                    data-bs-log-date="{{ log.session_date }}"
                                    data-bs-log-image="{{ log.image }}">✏</button>
                            <button class="delete-btn" data-bs-toggle="modal" data-bs-target="#deleteModal" data-bs-log-id="{{ log.id }}">×</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% endfor %}
        {% else %}
            <div class="no-log">No climb sessions yet. Start by uploading your first one!</div>
        {% endif %}
    </div>
    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="uploadModalLabel">Upload New Climb Session</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form method="post" enctype="multipart/form-data" lang="en">
            <div class="modal-body">
                <div class="mb-3">
                    <label for="name" class="form-label">Climber Name</label>
                    <input class="form-control" type="text" id="name" name="name" placeholder="Enter climber name" required lang="en">
                </div>
                <div class="mb-3">
                    <label for="route_id" class="form-label">Route</label>
                    <select class="form-control" id="route_id" name="route_id" required lang="en">
                        <option value="">Select a route</option>
                        {% for route in routes %}
                            <option value="{{ route.id }}">Route #{{ route.id }} - {{ route.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="image" class="form-label">Climb Photo</label>
                    <div class="custom-file-input">
                        <input type="file" id="image" name="image" accept="image/*" required lang="en" title="Choose photo file" data-locale="en-US">
                        <label for="image" class="custom-file-label">Choose photo file</label>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="note" class="form-label">Session Notes</label>
                    <textarea class="form-control" id="note" name="note" rows="2" placeholder="Beta, crux, style, technique notes, etc." lang="en"></textarea>
                </div>
                <div class="mb-3">
                    <label for="date" class="form-label">Session Date</label>
                    <div class="date-picker-wrapper">
                        <input type="text" id="date" name="date" class="date-picker-input" placeholder="Select date" readonly required>
                        <input type="hidden" id="date-value" name="date">
                        <span class="date-picker-icon">📅</span>
                        <div class="date-picker-dropdown" id="datePicker">
                            <div class="date-picker-header">
                                <button type="button" class="date-picker-nav" id="prevMonth">‹</button>
                                <span class="date-picker-month-year" id="monthYear"></span>
                                <button type="button" class="date-picker-nav" id="nextMonth">›</button>
                            </div>
                            <div class="date-picker-grid" id="dateGrid">
                                <div class="date-picker-day-header">Sun</div>
                                <div class="date-picker-day-header">Mon</div>
                                <div class="date-picker-day-header">Tue</div>
                                <div class="date-picker-day-header">Wed</div>
                                <div class="date-picker-day-header">Thu</div>
                                <div class="date-picker-day-header">Fri</div>
                                <div class="date-picker-day-header">Sat</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger">Upload</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Edit Climb Session</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="editForm" method="post" enctype="multipart/form-data" lang="en">
            <div class="modal-body">
                <div class="mb-3">
                    <label for="editName" class="form-label">Climber Name</label>
                    <input class="form-control" type="text" id="editName" name="name" placeholder="Enter climber name" required lang="en">
                </div>
                <div class="mb-3">
                    <label for="editRoute" class="form-label">Route</label>
                    <select class="form-control" id="editRoute" name="route_id" required lang="en">
                        <option value="">Select a route</option>
                        {% for route in routes %}
                            <option value="{{ route.id }}">Route #{{ route.id }} - {{ route.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="editImage" class="form-label">Climb Photo</label>
                    <div class="custom-file-input">
                        <input type="file" id="editImage" name="image" accept="image/*" lang="en" title="Choose photo file" data-locale="en-US">
                        <label for="editImage" class="custom-file-label">Choose new photo (optional)</label>
                    </div>
                    <div id="currentImageDisplay" class="mt-2" style="display: none;">
                        <small class="text-muted">Current photo: <span id="currentImageName"></span></small>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="editNote" class="form-label">Session Notes</label>
                    <textarea class="form-control" id="editNote" name="note" rows="2" placeholder="Beta, crux, style, technique notes, etc." lang="en"></textarea>
                </div>
                <div class="mb-3">
                    <label for="editDate" class="form-label">Session Date</label>
                    <div class="date-picker-wrapper">
                        <input type="text" id="editDate" class="date-picker-input" placeholder="Select date" readonly required>
                        <input type="hidden" id="editDateValue" name="date">
                        <span class="date-picker-icon">📅</span>
                        <div class="date-picker-dropdown" id="editDatePicker">
                            <div class="date-picker-header">
                                <button type="button" class="date-picker-nav" id="editPrevMonth">‹</button>
                                <span class="date-picker-month-year" id="editMonthYear"></span>
                                <button type="button" class="date-picker-nav" id="editNextMonth">›</button>
                            </div>
                            <div class="date-picker-grid" id="editDateGrid">
                                <div class="date-picker-day-header">Sun</div>
                                <div class="date-picker-day-header">Mon</div>
                                <div class="date-picker-day-header">Tue</div>
                                <div class="date-picker-day-header">Wed</div>
                                <div class="date-picker-day-header">Thu</div>
                                <div class="date-picker-day-header">Fri</div>
                                <div class="date-picker-day-header">Sat</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger">Update</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this climb session?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <form id="deleteForm" method="post">
              <button type="submit" class="btn btn-danger">Delete</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Force English locale for form elements
            document.documentElement.lang = 'en';
            document.body.lang = 'en';
            
            // Set locale for date inputs specifically
            const dateInput = document.getElementById('date');
            if (dateInput) {
                dateInput.setAttribute('lang', 'en-US');
                // Force English date format
                dateInput.style.direction = 'ltr';
            }
            
            // Set locale for file input specifically
            const fileInput = document.getElementById('image');
            if (fileInput) {
                fileInput.setAttribute('lang', 'en-US');
                
                // Handle custom file input
                fileInput.addEventListener('change', function() {
                    const fileName = this.files[0] ? this.files[0].name : 'Choose photo file';
                    const label = document.querySelector('.custom-file-label');
                    if (label) {
                        label.textContent = fileName;
                    }
                });
            }
            
            // Set locale for edit file input specifically
            const editFileInput = document.getElementById('editImage');
            if (editFileInput) {
                editFileInput.setAttribute('lang', 'en-US');
                
                // Handle custom file input for edit modal
                editFileInput.addEventListener('change', function() {
                    const fileName = this.files[0] ? this.files[0].name : 'Choose new photo (optional)';
                    const label = document.querySelector('#editModal .custom-file-label');
                    if (label) {
                        label.textContent = fileName;
                    }
                });
            }
            
            const deleteButtons = document.querySelectorAll('.delete-btn');
            const editButtons = document.querySelectorAll('.edit-btn');
            const manageBtn = document.getElementById('manageBtn');
            const timeline = document.querySelector('.timeline');
            let isManageMode = false;
            
            // Handle delete button clicks
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const logId = this.getAttribute('data-bs-log-id');
                    document.getElementById('deleteForm').action = '/delete-session/' + logId;
                });
            });
            
            // Handle edit button clicks
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const logId = this.getAttribute('data-bs-log-id');
                    const name = this.getAttribute('data-bs-log-name');
                    const routeId = this.getAttribute('data-bs-log-route-id');
                    const note = this.getAttribute('data-bs-log-note');
                    const date = this.getAttribute('data-bs-log-date');
                    const image = this.getAttribute('data-bs-log-image');
                    
                    console.log('Edit clicked:', { logId, name, routeId, note, date, image }); // Debug log
                    
                    // Populate the edit form
                    document.getElementById('editName').value = name || '';
                    document.getElementById('editRoute').value = routeId || '';
                    document.getElementById('editNote').value = note || '';
                    
                    // Show current image info
                    if (image && image !== 'None' && image.trim() !== '') {
                        document.getElementById('currentImageDisplay').style.display = 'block';
                        document.getElementById('currentImageName').textContent = image;
                    } else {
                        document.getElementById('currentImageDisplay').style.display = 'none';
                    }
                    
                    // Set the date in the edit date picker
                    if (date && date !== 'None') {
                        console.log('Setting date:', date); // Debug log
                        // Parse YYYY-MM-DD format
                        const dateParts = date.split('-');
                        if (dateParts.length === 3) {
                            const year = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
                            const day = parseInt(dateParts[2]);
                            const editDate = new Date(year, month, day);
                            
                            console.log('Parsed date:', editDate); // Debug log
                            
                            editDatePicker.selectedDate = editDate;
                            editDatePicker.currentDate = new Date(editDate);
                            editDatePicker.updateInput();
                            editDatePicker.render();
                        }
                    } else {
                        // Set to today if no date is provided
                        const today = new Date();
                        editDatePicker.selectedDate = today;
                        editDatePicker.currentDate = new Date(today);
                        editDatePicker.updateInput();
                        editDatePicker.render();
                        console.log('No date provided, setting to today:', today); // Debug log
                    }
                    
                    // Set the form action
                    const editForm = document.getElementById('editForm');
                    editForm.action = '/edit-session/' + logId;
                    console.log('Form action set to:', editForm.action); // Debug log
                });
            });
            
            // Handle manage button click
            manageBtn.addEventListener('click', function() {
                isManageMode = !isManageMode;
                
                if (isManageMode) {
                    timeline.classList.add('manage-mode');
                    manageBtn.textContent = 'Done';
                    manageBtn.classList.add('active');
                } else {
                    timeline.classList.remove('manage-mode');
                    manageBtn.textContent = 'Manage';
                    manageBtn.classList.remove('active');
                }
            });
            
            // Custom Date Picker Implementation
            const customDatePicker = {
                currentDate: new Date(),
                selectedDate: null,
                
                monthNames: ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'],
                
                init: function() {
                    this.bindEvents();
                    this.setToday();
                    this.render();
                },
                
                bindEvents: function() {
                    const input = document.getElementById('date');
                    const dropdown = document.getElementById('datePicker');
                    const prevBtn = document.getElementById('prevMonth');
                    const nextBtn = document.getElementById('nextMonth');
                    
                    input.addEventListener('click', () => {
                        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                    });
                    
                    prevBtn.addEventListener('click', () => {
                        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                        this.render();
                    });
                    
                    nextBtn.addEventListener('click', () => {
                        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                        this.render();
                    });
                    
                    // Close picker when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.date-picker-wrapper')) {
                            dropdown.style.display = 'none';
                        }
                    });
                },
                
                setToday: function() {
                    const today = new Date();
                    this.selectedDate = today;
                    this.currentDate = new Date(today);
                    this.updateInput();
                },
                
                updateInput: function() {
                    if (this.selectedDate) {
                        const input = document.getElementById('date');
                        const hiddenInput = document.getElementById('date-value');
                        const formatted = this.formatDate(this.selectedDate);
                        input.value = formatted;
                        hiddenInput.value = this.selectedDate.toISOString().split('T')[0];
                    }
                },
                
                formatDate: function(date) {
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${month}/${day}/${year}`;
                },
                
                render: function() {
                    this.renderHeader();
                    this.renderDays();
                },
                
                renderHeader: function() {
                    const monthYear = document.getElementById('monthYear');
                    monthYear.textContent = `${this.monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
                },
                
                renderDays: function() {
                    const grid = document.getElementById('dateGrid');
                    const dayHeaders = grid.querySelectorAll('.date-picker-day-header');
                    
                    // Remove existing day buttons
                    const existingDays = grid.querySelectorAll('.date-picker-day');
                    existingDays.forEach(day => day.remove());
                    
                    const year = this.currentDate.getFullYear();
                    const month = this.currentDate.getMonth();
                    
                    // First day of month and how many days
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const daysInMonth = lastDay.getDate();
                    const startingDayOfWeek = firstDay.getDay();
                    
                    // Previous month days
                    for (let i = 0; i < startingDayOfWeek; i++) {
                        const prevDate = new Date(year, month, -startingDayOfWeek + i + 1);
                        const dayBtn = this.createDayButton(prevDate, true);
                        grid.appendChild(dayBtn);
                    }
                    
                    // Current month days
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const dayBtn = this.createDayButton(date, false);
                        grid.appendChild(dayBtn);
                    }
                    
                    // Next month days to fill grid
                    const totalCells = grid.children.length;
                    const remainingCells = 42 - totalCells; // 6 rows × 7 days
                    for (let day = 1; day <= remainingCells && totalCells < 42; day++) {
                        const nextDate = new Date(year, month + 1, day);
                        const dayBtn = this.createDayButton(nextDate, true);
                        grid.appendChild(dayBtn);
                    }
                },
                
                createDayButton: function(date, isOtherMonth) {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'date-picker-day';
                    button.textContent = date.getDate();
                    
                    if (isOtherMonth) {
                        button.classList.add('other-month');
                    }
                    
                    if (this.selectedDate && this.isSameDay(date, this.selectedDate)) {
                        button.classList.add('selected');
                    }
                    
                    button.addEventListener('click', () => {
                        this.selectedDate = new Date(date);
                        this.updateInput();
                        document.getElementById('datePicker').style.display = 'none';
                        this.render();
                    });
                    
                    return button;
                },
                
                isSameDay: function(date1, date2) {
                    return date1.getDate() === date2.getDate() &&
                           date1.getMonth() === date2.getMonth() &&
                           date1.getFullYear() === date2.getFullYear();
                }
            };
            
            // Initialize custom date picker
            customDatePicker.init();
            
            // Edit Date Picker Implementation (separate instance for edit modal)
            const editDatePicker = {
                currentDate: new Date(),
                selectedDate: null,
                
                monthNames: ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'],
                
                init: function() {
                    this.bindEvents();
                },
                
                bindEvents: function() {
                    const input = document.getElementById('editDate');
                    const dropdown = document.getElementById('editDatePicker');
                    const prevBtn = document.getElementById('editPrevMonth');
                    const nextBtn = document.getElementById('editNextMonth');
                    
                    input.addEventListener('click', () => {
                        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                    });
                    
                    prevBtn.addEventListener('click', () => {
                        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                        this.render();
                    });
                    
                    nextBtn.addEventListener('click', () => {
                        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                        this.render();
                    });
                    
                    // Close picker when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('#editModal .date-picker-wrapper')) {
                            dropdown.style.display = 'none';
                        }
                    });
                },
                
                updateInput: function() {
                    if (this.selectedDate) {
                        const input = document.getElementById('editDate');
                        const hiddenInput = document.getElementById('editDateValue');
                        const formatted = this.formatDate(this.selectedDate);
                        input.value = formatted;
                        hiddenInput.value = this.selectedDate.toISOString().split('T')[0];
                    }
                },
                
                formatDate: function(date) {
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${month}/${day}/${year}`;
                },
                
                render: function() {
                    this.renderHeader();
                    this.renderDays();
                },
                
                renderHeader: function() {
                    const monthYear = document.getElementById('editMonthYear');
                    monthYear.textContent = `${this.monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
                },
                
                renderDays: function() {
                    const grid = document.getElementById('editDateGrid');
                    const dayHeaders = grid.querySelectorAll('.date-picker-day-header');
                    
                    // Remove existing day buttons
                    const existingDays = grid.querySelectorAll('.date-picker-day');
                    existingDays.forEach(day => day.remove());
                    
                    const year = this.currentDate.getFullYear();
                    const month = this.currentDate.getMonth();
                    
                    // First day of month and how many days
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const daysInMonth = lastDay.getDate();
                    const startingDayOfWeek = firstDay.getDay();
                    
                    // Previous month days
                    for (let i = 0; i < startingDayOfWeek; i++) {
                        const prevDate = new Date(year, month, -startingDayOfWeek + i + 1);
                        const dayBtn = this.createDayButton(prevDate, true);
                        grid.appendChild(dayBtn);
                    }
                    
                    // Current month days
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const dayBtn = this.createDayButton(date, false);
                        grid.appendChild(dayBtn);
                    }
                    
                    // Next month days to fill grid
                    const totalCells = grid.children.length;
                    const remainingCells = 42 - totalCells; // 6 rows × 7 days
                    for (let day = 1; day <= remainingCells && totalCells < 42; day++) {
                        const nextDate = new Date(year, month + 1, day);
                        const dayBtn = this.createDayButton(nextDate, true);
                        grid.appendChild(dayBtn);
                    }
                },
                
                createDayButton: function(date, isOtherMonth) {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'date-picker-day';
                    button.textContent = date.getDate();
                    
                    if (isOtherMonth) {
                        button.classList.add('other-month');
                    }
                    
                    if (this.selectedDate && this.isSameDay(date, this.selectedDate)) {
                        button.classList.add('selected');
                    }
                    
                    button.addEventListener('click', () => {
                        this.selectedDate = new Date(date);
                        this.updateInput();
                        document.getElementById('editDatePicker').style.display = 'none';
                        this.render();
                    });
                    
                    return button;
                },
                
                isSameDay: function(date1, date2) {
                    return date1.getDate() === date2.getDate() &&
                           date1.getMonth() === date2.getMonth() &&
                           date1.getFullYear() === date2.getFullYear();
                }
            };
            
            // Initialize edit date picker
            editDatePicker.init();
            
            // Add form submission debugging
            const editForm = document.getElementById('editForm');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    const formData = new FormData(this);
                    console.log('🚀 Edit form submission data:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`  ${key}: ${value}`);
                    }
                });
            }
        });
    </script>
</body>
</html> 